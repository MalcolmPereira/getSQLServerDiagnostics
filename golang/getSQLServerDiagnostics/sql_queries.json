{	
	"querysource":{
		"sqlserververion":"2022",
		"name":"SQL Server 2022 Diagnostic Information Queries",
		"author":"Glenn Berry ",
		"lastmodified":"Last Modified: October 6, 2025",
		"source":"https://glennsqlperformance.com/",
		"url":"https://glennsqlperformance.com/ https://sqlserverperformance.wordpress.com/ YouTube: https://bit.ly/2PkoAM1 Blue Sky: https://bsky.app/profile/glennalanberry.bsky.social", 		
		"comments":"-- Diagnostic Queries are available here -- https://glennsqlperformance.com/resources/ -- YouTube video demonstrating these queries -- https://bit.ly/3aXNDzJ -- Please make sure you are using the correct version of these diagnostic queries for your version of SQL Server -- If you like PowerShell, there is a very useful community solution for running these queries in an automated fashion -- https://dbatools.io/ -- Invoke-DbaDiagnosticQuery -- https://docs.dbatools.io/Invoke-DbaDiagnosticQuery",
		"copyright":"--****************************************************************************** --*   Copyright (C) 2025 Glenn Berry --*   All rights reserved.  --* --* --*   You may alter this code for your own *non-commercial* purposes. You may --*   republish altered code as long as you include this copyright and give due credit.  --* --* --*   THIS CODE AND INFORMATION ARE PROVIDED 'AS IS' WITHOUT WARRANTY OF --*   ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED  --*   TO THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A --*   PARTICULAR PURPOSE.  --* --*****************************************************************************"
	},
	"queries": [
		{
			"name": "CheckVersion",
			"description": "Confirm if the SQL Queries will work for the version of SQL Server",
			"query": "IF NOT EXISTS (SELECT * WHERE CONVERT(varchar(128), SERVERPROPERTY('ProductMajorVersion')) = '16') BEGIN DECLARE @ProductVersion varchar(128) = CONVERT(varchar(128), SERVERPROPERTY('ProductVersion'));RAISERROR ('Script does not match the ProductVersion [%s] of this instance. Many of these queries may not work on this version.' , 18 , 16 , @ProductVersion);END ELSE PRINT N'You have the correct major version of SQL Server for this diagnostic information script';",
			"notes":"Confirm if the SQL Queries will work for the version of SQL Server"
		},
		{
			"name": "OSVersion",
			"description": "SQL and OS Version information for current instance  (Query 1) (Version Info)",
			"query": "SELECT @@SERVERNAME AS [Server Name], @@VERSION AS [SQL Server and OS Version Info];",
			"notes":""
		},
		{
			"name": "TotalCores",
			"description": "Get socket, physical core and logical core count from the SQL Server Error log. (Query 2) (Core Counts)",
			"query": "EXEC sys.xp_readerrorlog 0, 1, N'detected', N'socket';",
			"notes":"This query might take a few seconds depending on the size of your error log. This can help you determine the exact core counts used by SQL Server and whether HT is enabled or not.This query will return no results if your error log has been recycled since the instance was last started"
		},
		{
			"name": "SQLServerProperties",
			"description": "Get selected server properties (Query 3) (Server Properties)",
			"query": "SELECT SERVERPROPERTY('MachineName') AS [MachineName], SERVERPROPERTY('ServerName') AS [ServerName], SERVERPROPERTY('InstanceName') AS [Instance], SERVERPROPERTY('IsClustered') AS [IsClustered],SERVERPROPERTY('ComputerNamePhysicalNetBIOS') AS [ComputerNamePhysicalNetBIOS],SERVERPROPERTY('Edition') AS [Edition],SERVERPROPERTY('ProductLevel') AS [ProductLevel],SERVERPROPERTY('ProductUpdateLevel') AS [ProductUpdateLevel],SERVERPROPERTY('ProductVersion') AS [ProductVersion],SERVERPROPERTY('ProductMajorVersion') AS [ProductMajorVersion],SERVERPROPERTY('ProductMinorVersion') AS [ProductMinorVersion],SERVERPROPERTY('ProductBuild') AS [ProductBuild],SERVERPROPERTY('ProductBuildType') AS [ProductBuildType],SERVERPROPERTY('ProductUpdateReference') AS [ProductUpdateReference], SERVERPROPERTY('ProcessID') AS [ProcessID],SERVERPROPERTY('Collation') AS [Collation], SERVERPROPERTY('IsFullTextInstalled') AS [IsFullTextInstalled], SERVERPROPERTY('IsIntegratedSecurityOnly') AS [IsIntegratedSecurityOnly],SERVERPROPERTY('FilestreamConfiguredLevel') AS [FilestreamConfiguredLevel],SERVERPROPERTY('IsHadrEnabled') AS [IsHadrEnabled], SERVERPROPERTY('HadrManagerStatus') AS [HadrManagerStatus],SERVERPROPERTY('InstanceDefaultDataPath') AS [InstanceDefaultDataPath],SERVERPROPERTY('InstanceDefaultLogPath') AS [InstanceDefaultLogPath],SERVERPROPERTY('InstanceDefaultBackupPath') AS [InstanceDefaultBackupPath],SERVERPROPERTY('ErrorLogFileName') AS [ErrorLogFileName],SERVERPROPERTY('BuildClrVersion') AS [Build CLR Version],SERVERPROPERTY('IsXTPSupported') AS [IsXTPSupported],SERVERPROPERTY('IsPolybaseInstalled') AS [IsPolybaseInstalled],SERVERPROPERTY('IsAdvancedAnalyticsInstalled') AS [IsRServicesInstalled],SERVERPROPERTY('IsTempdbMetadataMemoryOptimized') AS [IsTempdbMetadataMemoryOptimized],SERVERPROPERTY('IsServerSuspendedForSnapshotBackup') AS [IsServerSuspendedForSnapshotBackup],SERVERPROPERTY('SuspendedDatabaseCount') AS [SuspendedDatabaseCount];",
			"notes":"This gives you a lot of useful information about your instance of SQL Server,such as the ProcessID for SQL Server and your collation Note: Some columns will be NULL on older SQL Server builds"
		},
		{
			"name": "InstanceLevelConfig",
			"description": "Get instance-level configuration values for instance  (Query 4) (Configuration Values)",
			"query": "SELECT name, value, value_in_use, minimum, maximum, [description], is_dynamic, is_advanced FROM sys.configurations WITH (NOLOCK) ORDER BY name OPTION (RECOMPILE);",
			"notes":"Focus on these settings: automatic soft-NUMA disabled (should be 0 in most cases) backup checksum default (should be 1) backup compression algorithm backup compression default (should be 1 in most cases) clr enabled (only enable if it is needed) cost threshold for parallelism (depends on your workload) lightweight pooling (should be zero) max degree of parallelism (depends on your workload and hardware) max server memory (MB) (set to an appropriate value, not the default) optimize for ad hoc workloads (should be 1) priority boost (should be zero) remote admin connections (should be 1) tempdb metadata memory-optimized (0 by default, some workloads may benefit by enabling)"
		},
		{
			"name": "GlobalTraceFlag",
			"description": "Returns a list of all global trace flags that are enabled (Query 5) (Global Trace Flags)",
			"query": "DBCC TRACESTATUS (-1);",
			"notes":"If no global trace flags are enabled, no results will be returned. It is very useful to know what global trace flags are currently enabled as part of the diagnostic process. Common trace flags that should be enabled in most cases TF 3226 - Suppresses logging of successful database backup messages to the SQL Server Error Log TF 6534 - Enables use of native code to improve performance with spatial data. This is a startup trace flag only TF 7745 - Prevents Query Store data from being written to disk in case of a failover or shutdown command DBCC TRACEON - Trace Flags (Transact-SQL)"
		},
		{
			"name": "ProcessInfo",
			"description": "SQL Server Process Address space info  (Query 6) (Process Memory)",
			"query": "SELECT physical_memory_in_use_kb/1024 AS [SQL Server Memory Usage (MB)],locked_page_allocations_kb/1024 AS [SQL Server Locked Pages Allocation (MB)],large_page_allocations_kb/1024 AS [SQL Server Large Pages Allocation (MB)], page_fault_count, memory_utilization_percentage, available_commit_limit_kb, process_physical_memory_low, process_virtual_memory_low FROM sys.dm_os_process_memory WITH (NOLOCK) OPTION (RECOMPILE);",
			"notes":"Shows whether locked pages is enabled, among other things. You want to see 0 for process_physical_memory_low You want to see 0 for process_virtual_memory_low This indicates that you are not under internal memory pressure If locked_page_allocations_kb > 0, then LPIM is enabled"
		},
		{
			"name": "ServicesInfo",
			"description": "SQL Server Services information (Query 7) (SQL Server Services Info)",
			"query": "SELECT servicename, process_id, startup_type_desc, status_desc, last_startup_time, service_account, is_clustered, cluster_nodename, [filename], instant_file_initialization_enabled FROM sys.dm_server_services WITH (NOLOCK) OPTION (RECOMPILE);",
			"notes":"Tells you the account being used for the SQL Server Service and the SQL Agent Service Shows the process_id, when they were last started, and their current status Also shows whether you are running on a failover cluster instance, and what node you are running on Also shows whether IFI is enabled."
		},
		{
			"name": "LastBackUp",
			"description": "Last backup information by database  (Query 8) (Last Backup By Database)",
			"query": "SELECT ISNULL(d.[name], bs.[database_name]) AS [Database], d.recovery_model_desc AS [Recovery Model],  d.log_reuse_wait_desc AS [Log Reuse Wait Desc], CONVERT(DECIMAL(18,2), ds.cntr_value/1024.0) AS [Total Data File Size on Disk (MB)], CONVERT(DECIMAL(18,2), ls.cntr_value/1024.0) AS [Total Log File Size on Disk (MB)],  CAST(CAST(lu.cntr_value AS FLOAT) / CAST(ls.cntr_value AS FLOAT) AS DECIMAL(18,2)) * 100 AS [Log Used %], MAX(CASE WHEN bs.[type] = 'D' THEN bs.backup_finish_date ELSE NULL END) AS [Last Full Backup], MAX(CASE WHEN bs.[type] = 'D' THEN CONVERT (BIGINT, bs.compressed_backup_size / 1048576 ) ELSE NULL END) AS [Last Full Compressed Backup Size (MB)], MAX(CASE WHEN bs.[type] = 'D' THEN CONVERT (DECIMAL(18,2), bs.backup_size /bs.compressed_backup_size ) ELSE NULL END) AS [Backup Compression Ratio], MAX(CASE WHEN bs.[type] = 'D' THEN bs.compression_algorithm ELSE NULL END) AS [Last Full Backup Compression Algorithm], MAX(CASE WHEN bs.[type] = 'I' THEN bs.backup_finish_date ELSE NULL END) AS [Last Differential Backup], MAX(CASE WHEN bs.[type] = 'L' THEN bs.backup_finish_date ELSE NULL END) AS [Last Log Backup], MAX(CASE WHEN bs.[type] = 'L' THEN bs.last_valid_restore_time ELSE NULL END) AS [Last Valid Restore Time], DATABASEPROPERTYEX ((d.[name]), 'LastGoodCheckDbTime') AS [Last Good CheckDB] FROM sys.databases AS d WITH (NOLOCK) INNER JOIN sys.master_files as mf WITH (NOLOCK) ON d.database_id = mf.database_id LEFT OUTER JOIN msdb.dbo.backupset AS bs WITH (NOLOCK) ON bs.[database_name] = d.[name] AND bs.backup_finish_date > GETDATE()- 30 LEFT OUTER JOIN sys.dm_os_performance_counters AS lu WITH (NOLOCK) ON d.name = lu.instance_name LEFT OUTER JOIN sys.dm_os_performance_counters AS ls WITH (NOLOCK) ON d.name = ls.instance_name INNER JOIN sys.dm_os_performance_counters AS ds WITH (NOLOCK) ON d.name = ds.instance_name WHERE d.name <> N'tempdb' AND lu.counter_name LIKE N'Log File(s) Used Size (KB)%'  AND ls.counter_name LIKE N'Log File(s) Size (KB)%' AND ds.counter_name LIKE N'Data File(s) Size (KB)%' AND ls.cntr_value > 0  GROUP BY ISNULL(d.[name], bs.[database_name]), d.recovery_model_desc, d.log_reuse_wait_desc, d.[name], CONVERT(DECIMAL(18,2), ds.cntr_value/1024.0), CONVERT(DECIMAL(18,2), ls.cntr_value/1024.0),  CAST(CAST(lu.cntr_value AS FLOAT) / CAST(ls.cntr_value AS FLOAT) AS DECIMAL(18,2)) * 100 ORDER BY d.recovery_model_desc, d.[name] OPTION (RECOMPILE);",
			"notes":"This helps you spot runaway transaction logs and other issues with your backup schedule"
		},
		{
			"name": "GetAccelerator",
			"description": "Get detailed accelerator status information (Query 9) (Accelerator Status)",
			"query": "SELECT accelerator, accelerator_desc, config, config_in_use , mode, mode_desc, mode_reason, mode_reason_desc, accelerator_hardware_detected, accelerator_library_version, accelerator_driver_version FROM sys.dm_server_accelerator_status WITH (NOLOCK) OPTION (RECOMPILE);",
			"notes":"This shows which accelerators are present and their detailed status information"
		},
		{
			"name": "GetAgentJobs",
			"description": "Get SQL Server Agent jobs and Category information (Query 10) (SQL Server Agent Jobs)",
			"query": "SELECT sj.name AS [Job Name], sj.[description] AS [Job Description], sc.name AS [CategoryName], SUSER_SNAME(sj.owner_sid) AS [Job Owner], sj.date_created AS [Date Created], sj.[enabled] AS [Job Enabled], h.run_status, CONVERT(DATETIME, RTRIM(h.run_date) + ' ' + STUFF(STUFF(REPLACE(STR(RTRIM(h.run_time),6,0),' ','0'),3,0,':'),6,0,':')) AS [Last Start Date], RIGHT(STUFF(STUFF(REPLACE(STR(h.run_duration, 7, 0), ' ', '0'), 4, 0, ':'), 7, 0, ':'),8) AS [Last Duration - HHMMSS], s.[name] AS [Schedule Name], s.[enabled] AS [Schedule Enabled], js.next_run_date, js.next_run_time FROM msdb.dbo.sysjobs AS sj WITH (NOLOCK) LEFT OUTER JOIN (SELECT job_id, instance_id = MAX(instance_id) FROM msdb.dbo.sysjobhistory WITH (NOLOCK) GROUP BY job_id) AS l ON sj.job_id = l.job_id LEFT OUTER JOIN msdb.dbo.syscategories AS sc WITH (NOLOCK) ON sj.category_id = sc.category_id LEFT OUTER JOIN msdb.dbo.sysjobhistory AS h WITH (NOLOCK) ON h.job_id = l.job_id AND h.instance_id = l.instance_id LEFT OUTER JOIN msdb.dbo.sysjobs_view AS jv WITH (NOLOCK) ON jv.job_id = sj.job_id LEFT OUTER JOIN msdb.dbo.sysjobschedules AS js WITH (NOLOCK) ON jv.job_id = js.job_id LEFT OUTER JOIN msdb.dbo.sysschedules AS s WITH (NOLOCK) ON s.schedule_id = js.schedule_id ORDER BY CONVERT(INT, h.run_duration) DESC, [Last Start Date] DESC OPTION (RECOMPILE);",
			"notes":"Where run_status Value Status of the job execution 0=Failed,1=Succeeded,2=Retry,3=Canceled,4=In Progress. Gives you some basic information about your SQL Server Agent jobs, who owns them and how they are configured Look for Agent jobs that are not owned by sa Look for jobs that have a notify_email_operator_id set to 0 (meaning no operator) Look for jobs that have a notify_level_email set to 0 (meaning no e-mail is ever sent)"
		},
		{
			"name": "GetAgentAlertInfo",
			"description": "Get SQL Server Agent Alert Information (Query 11) (SQL Server Agent Alerts)",
			"query": "SELECT name, event_source, message_id, severity, [enabled], has_notification, delay_between_responses, occurrence_count, last_occurrence_date, last_occurrence_time FROM msdb.dbo.sysalerts WITH (NOLOCK) ORDER BY name OPTION (RECOMPILE);",
			"notes":"Gives you some basic information about your SQL Server Agent Alerts which are different from SQL Server Agent jobs"
		},
		{
			"name": "HostInformation",
			"description": "Host information (Query 12) (Host Info)",
			"query": "SELECT host_platform, host_distribution, host_release, host_service_pack_level, host_sku, os_language_version,host_architecture FROM sys.dm_os_host_info WITH (NOLOCK) OPTION (RECOMPILE); ",
			"notes":"."
		},
		{
			"name": "OSVersion",
			"description": "Get version",
			"query": "SELECT @@SERVERNAME AS server_name, @@VERSION AS version_info;",
			"notes":"This is useful to find out the version of SQL Server being used."
		}
	]
}

